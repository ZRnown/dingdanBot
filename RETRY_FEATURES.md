# 重试机制和状态检查功能说明

## 1. 订单获取重试机制

### 功能说明
- 在获取订单列表时，如果遇到网络错误或HTTP错误（如502），会自动重试
- 最多重试10次
- 重试间隔递增：第1次等待2秒，第2次等待4秒，第3次等待6秒...以此类推
- 如果某一页获取失败，会跳过该页继续获取下一页，直到获取完最近2天的所有订单

### 实现位置
- `order_api.py` 中的 `get_orders_page()` 方法
- `order_api.py` 中的 `get_recent_orders()` 方法

## 2. 订单同步重试机制

### 功能说明
- 在同步订单到系统时，如果失败会自动重试
- 最多重试10次
- 每次重试间隔：随机3-5分钟（180-300秒）
- 重试过程中会显示当前尝试次数和等待时间

### 实现位置
- `order_api.py` 中的 `sync_order()` 方法
- `bot.py` 中的 `handle_message()` 方法

## 3. 订单状态检查

### 功能说明
- 在同步订单前，会检查订单状态
- 如果订单状态包含以下关键词之一，会停止同步：
  - 退单中
  - 已退款
  - 已退单
  - 退款中
  - 退单
- 如果检测到退单状态，会向用户发送提示消息

### 实现位置
- `database.py` 中的 `is_refund_status()` 方法
- `bot.py` 中的 `handle_message()` 方法

## 使用示例

### 订单获取重试
```
正在获取第 8 页...
获取订单失败: HTTP 502，2秒后重试 (尝试 1/10)
获取订单失败: HTTP 502，4秒后重试 (尝试 2/10)
...
```

### 订单同步重试
```
订单 123456 同步失败: HTTP 500，3.5分钟后重试 (尝试 1/10)
订单 123456 同步失败: HTTP 500，4.2分钟后重试 (尝试 2/10)
...
订单 123456 同步成功
```

### 退单状态检测
```
找到订单 ID: 123456
检测到退单关键词: 已退款
订单 123456 处于退单状态，跳过同步
```

## 配置说明

重试参数可以在代码中调整：
- `get_orders_page()`: `max_retries=10` - 最大重试次数
- `sync_order()`: 
  - `max_retries=10` - 最大重试次数
  - `retry_interval_min=3` - 最小重试间隔（分钟）
  - `retry_interval_max=5` - 最大重试间隔（分钟）

